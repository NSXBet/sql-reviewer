# PostgreSQL Production Configuration
# A practical, production-ready configuration with sensible defaults
# This config enables the most important rules for maintaining PostgreSQL database quality

id: postgres-production
rules:
  # ============================================================================
  # CRITICAL RULES (ERROR level) - Must be fixed
  # ============================================================================

  # Disallow SELECT * to avoid ambiguity and performance issues
  - type: statement.select.no-select-all
    level: ERROR
    engine: POSTGRES
  # Require WHERE clause for UPDATE/DELETE to prevent accidental data loss
  - type: statement.where.require.update-delete
    level: ERROR
    engine: POSTGRES
  # Disallow COMMIT statements in migration scripts
  - type: statement.disallow-commit
    level: ERROR
    engine: POSTGRES
  # Require primary key on all tables
  - type: table.require-pk
    level: ERROR
    engine: POSTGRES
  # Disallow CASCADE when dropping tables (safety)
  - type: statement.disallow-rm-tbl-cascade
    level: ERROR
    engine: POSTGRES
  # INSERT must specify columns for clarity
  - type: statement.insert.must-specify-column
    level: ERROR
    engine: POSTGRES
  # Disallow changing column type (can cause data loss)
  - type: column.disallow-change-type
    level: ERROR
    engine: POSTGRES
  # Disallow duplicate columns in index
  - type: index.no-duplicate-column
    level: ERROR
    engine: POSTGRES
  # Primary key type allowlist - prefer integer types
  - type: index.primary-key-type-allowlist
    level: ERROR
    payload:
      list:
        - serial
        - bigserial
        - int
        - integer
        - bigint
        - int4
        - int8
        - uuid
    engine: POSTGRES
  # Column type disallow list
  - type: column.type-disallow-list
    level: ERROR
    payload:
      list:
        - MONEY # Use NUMERIC instead for better precision
    engine: POSTGRES
  # ============================================================================
  # PERFORMANCE & SAFETY RULES (WARNING level)
  # ============================================================================

  # Disallow leading % in LIKE (can't use index)
  - type: statement.where.no-leading-wildcard-like
    level: WARNING
    engine: POSTGRES
  # Create indexes concurrently to avoid blocking writes
  - type: index.create-concurrently
    level: WARNING
    engine: POSTGRES
  # Disallow adding column with DEFAULT (causes table rewrite in older PG versions)
  - type: statement.disallow-add-column-with-default
    level: WARNING
    engine: POSTGRES
  # Require NOT VALID when adding CHECK constraints (avoids full table scan)
  - type: statement.add-check-not-valid
    level: WARNING
    engine: POSTGRES
  # Require NOT VALID when adding foreign keys (avoids full table scan)
  - type: statement.add-foreign-key-not-valid
    level: WARNING
    engine: POSTGRES
  # Disallow adding NOT NULL to existing columns (can cause downtime)
  - type: statement.disallow-add-not-null
    level: WARNING
    engine: POSTGRES
  # Disallow volatile default values (e.g., clock_timestamp())
  - type: column.default-disallow-volatile
    level: WARNING
    engine: POSTGRES
  # Limit inserted rows
  - type: statement.insert.row-limit
    level: WARNING
    payload:
      number: 5000
    engine: POSTGRES
  # Limit affected rows for UPDATE/DELETE
  - type: statement.affected-row-limit
    level: WARNING
    payload:
      number: 10000
    engine: POSTGRES
  # Maximum LIMIT value
  - type: statement.maximum-limit-value
    level: WARNING
    payload:
      number: 5000
    engine: POSTGRES
  # ============================================================================
  # CODE QUALITY RULES (WARNING level)
  # ============================================================================

  # Table naming convention - snake_case
  - type: naming.table
    level: WARNING
    payload:
      format: "^[a-z][a-z0-9]*(_[a-z0-9]+)*$"
      maxLength: 63
    engine: POSTGRES
  # Column naming convention - snake_case
  - type: naming.column
    level: WARNING
    payload:
      format: "^[a-z][a-z0-9]*(_[a-z0-9]+)*$"
      maxLength: 63
    engine: POSTGRES
  # Index naming convention
  - type: naming.index.idx
    level: WARNING
    payload:
      format: "^$|^idx_{{table}}_{{column_list}}$"
      maxLength: 63
    engine: POSTGRES
  # Unique key naming convention
  - type: naming.index.uk
    level: WARNING
    payload:
      format: "^$|^uk_{{table}}_{{column_list}}$"
      maxLength: 63
    engine: POSTGRES
  # Foreign key naming convention
  - type: naming.index.fk
    level: WARNING
    payload:
      format: "^$|^fk_{{referencing_table}}_{{referencing_column}}_{{referenced_table}}_{{referenced_column}}$"
      maxLength: 63
    engine: POSTGRES
  # Merge ALTER TABLE statements for better readability
  - type: statement.merge-alter-table
    level: WARNING
    engine: POSTGRES
  # Disallow mixing DDL statements
  - type: statement.disallow-mix-in-ddl
    level: WARNING
    engine: POSTGRES
  # Disallow mixing DML statements
  - type: statement.disallow-mix-in-dml
    level: WARNING
    engine: POSTGRES
  # Table comment convention
  - type: table.comment
    level: WARNING
    payload:
      required: false
      maxLength: 1024
    engine: POSTGRES
  # Column comment convention
  - type: column.comment
    level: WARNING
    payload:
      required: false
      maxLength: 1024
    engine: POSTGRES
  # Columns should not be NULL by default
  - type: column.no-null
    level: WARNING
    engine: POSTGRES
  # Maximum CHAR length
  - type: column.maximum-character-length
    level: WARNING
    payload:
      number: 255
    engine: POSTGRES
  # Limit index key count
  - type: index.key-number-limit
    level: WARNING
    payload:
      number: 5
    engine: POSTGRES

# ============================================================================
# OPTIONAL RULES (Commented out - enable as needed)
# ============================================================================

# Fully qualified object name - require schema.table format
# - type: naming.fully-qualified
#   level: WARNING
#   engine: POSTGRES

# Require WHERE clause for SELECT statements
# - type: statement.where.require.select
#   level: WARNING
#   engine: POSTGRES

# Disallow foreign keys (for high-scale applications)
# - type: table.no-foreign-key
#   level: WARNING
#   engine: POSTGRES

# Disallow ON DELETE CASCADE
# - type: statement.disallow-on-del-cascade
#   level: WARNING
#   engine: POSTGRES

# Require explicit schema specification
# - type: statement.create-specify-schema
#   level: WARNING
#   engine: POSTGRES

# Require column default value
# - type: column.require-default
#   level: WARNING
#   engine: POSTGRES

# Charset allowlist
# - type: system.charset.allowlist
#   level: WARNING
#   payload:
#     list:
#       - UTF8
#   engine: POSTGRES

# Collation allowlist
# - type: system.collation.allowlist
#   level: WARNING
#   payload:
#     list:
#       - en_US.UTF-8
#       - C
#   engine: POSTGRES
